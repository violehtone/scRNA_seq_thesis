---
title: "Cell_annotations"
author: "Ville Lehtonen"
date: "11/3/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working dir to the source file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

# Cell annotations
This script uses SingleR (https://github.com/LTLA/SingleR) to perform the mapping of primary data cells into the reference data cell types

## 1. Load packages and data
### 1.1 Load packages
```{r load-packages, message=FALSE}
library(SCORPIUS)
library(SingleR)
library(SingleCellExperiment)
library(reshape)
library(scater)
library(scran)
library(data.table)
library(gridExtra)
library(BBmisc)
library(tidyr)
library(ggpubr)
library(ggplot2)
library(grid)
library(RColorBrewer)
```

### 1.2 Load pre-calculated data
**Single Cell Experiments**
```{r load-objects}
# Load pre-processed sce objects
denoised.sce <- readRDS("./../saved/R_objects/denoised_sce_clust")
denoised.sce.deMicheli <- readRDS("./../saved/R_objects/denoised_sce_deMicheli")
denoised.sce.dellOrso <- readRDS("./../saved/R_objects/denoised_sce_dellOrso")
```

**Cell cycle genes (from OSCA pipeline)**
```{r cc-genes-osca-shortcut}
# Get OSCA cell cycle genes
cc.genes.osca <- readRDS("./../saved/R_objects/cc_genes_osca")

# Create new datasets where the cell cycle genes have been removed
denoised.sce.cc.genes <- denoised.sce[!(rownames(denoised.sce) %in% cc.genes.osca), ]
denoised.sce.deMicheli.cc.genes <- denoised.sce.deMicheli[!(rownames(denoised.sce.deMicheli) %in% cc.genes.osca), ]
denoised.sce.dellOrso.cc.genes <- denoised.sce.dellOrso[!(rownames(denoised.sce.dellOrso) %in% cc.genes.osca), ]
```


## 2. Prediction of cell types from De Micheli et al. (2020) dataset
### 2.1 All genes
#### 2.1.1 Cell annotations
**Load pre-calculated predictions (if available)**
```{r load-deMicheli-cell-type-predictions}
# Load pre-saved prediction objects
pred.deMicheli <- readRDS("./../saved/R_objects/pred_deMicheli")

# Print the de genes used
de.genes.pred.deMicheli <- metadata(pred.deMicheli)$common.genes
print(de.genes.pred.deMicheli)

# Assign cell types to primary data
denoised.sce$cell_type_deMicheli <- pred.deMicheli$pruned.labels
```

**Perform cell annotation using SingleR (optional)**
```{r deMicheli-cell-type-predictions, eval=FALSE}
pred.deMicheli <- SingleR(test = denoised.sce,
                          assay.type.test = "logcounts",
                          ref = denoised.sce.deMicheli,
                          labels = denoised.sce.deMicheli$cell_type)

# Assign cell types to primary data
denoised.sce$cell_type_deMicheli <- pred.deMicheli$pruned.labels

#saveRDS(pred.deMicheli, file = "./../saved/R_objects/pred_deMicheli")
```

#### 2.1.2 Diagnostic plots
**Diagnostics**
```{r deMicheli-annotation-diagnostic-plots}
# Score heatmap
plotScoreHeatmap(pred.deMicheli, annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]), width = 10)

# Remove low-quality cells
to.remove <- pruneScores(pred.deMicheli, min.diff.next = 0.1)
table(Label=pred.deMicheli$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(results = pred.deMicheli, show = "delta.med")
```

**Pdf documents**
```{r deMicheli-annotation-diagnostic-plots-pdf, eval=FALSE}
# Visualize the score matrix
pdf("./../saved/figures/deMicheli_score_heatmap.pdf", width = 30, height = 50)
plotScoreHeatmap(pred.deMicheli, 
                 annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]), width = 10)
dev.off()

to.remove <- pruneScores(pred.deMicheli, min.diff.next=0.1)
table(Label=pred.deMicheli$labels, Removed=to.remove)


# Delta distribution
pdf("./../saved/figures/deMicheli_score_distribution.pdf", width = 20, height = 15)
plotScoreDistribution(results = pred.deMicheli, show = "delta.med")
dev.off()

# Get marker genes
all.markers.deMicheli <- metadata(pred.deMicheli)$de.genes

# Write markers for each sample into a csv file
all.markers.deMicheli.df <- data.table("d0_mature_skeletal_muscle" = unique(unlist(all.markers.deMicheli$d0_mature_skeletal_muscle)),
                                       "d0_MuSCs_and_progenitors" = unique(unlist(all.markers.deMicheli$d0_MuSCs_and_progenitors)),
                                       "d5_mature_skeletal_muscle" = unique(unlist(all.markers.deMicheli$d5_mature_skeletal_muscle)),
                                       "d5_MuSCs_and_progenitors" = unique(unlist(all.markers.deMicheli$d5_MuSCs_and_progenitors)),
                                       "d7_mature_skeletal_muscle" = unique(unlist(all.markers.deMicheli$d7_mature_skeletal_muscle)),
                                       "d7_MuSCs_and_progenitors" = unique(unlist(all.markers.deMicheli$d7_MuSCs_and_progenitors)))
write.csv(all.markers.deMicheli.df, file ="./../saved/tables/all_markers_deMicheli.csv")

# Examine the expression of the marker genes for each label in the test dataset
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_d0_muscle.pdf")
plotHeatmap(denoised.sce,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d0_mature_skeletal_muscle)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_d0_musc.pdf")
plotHeatmap(denoised.sce,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d0_MuSCs_and_progenitors)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_d5_muscle.pdf")
plotHeatmap(denoised.sce,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d5_mature_skeletal_muscle)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_d5_musc.pdf")
plotHeatmap(denoised.sce,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d5_MuSCs_and_progenitors)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_d7_muscle.pdf")
plotHeatmap(denoised.sce,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d7_mature_skeletal_muscle)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_d7_musc.pdf")
plotHeatmap(denoised.sce,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d7_MuSCs_and_progenitors)),
            fontsize_row = 2)
dev.off()
```

### 2.2 Without cell cycle genes
#### 2.2.1 Cell annotations without cc genes
**Load pre-calculated predictions (if available)**
```{r load-deMicheli-cell-type-predictions-cc-genes}
pred.deMicheli.cc.genes <- readRDS("./../saved/R_objects/pred_deMicheli_cc_genes")

# Assign cell types to primary data
denoised.sce.cc.genes$cell_type_deMicheli <- pred.deMicheli.cc.genes$pruned.labels
```

**Perform cell annotation using SingleR (optional)**
```{r deMicheli-cell-type-predictions-cc-genes, eval=FALSE}
pred.deMicheli.cc.genes <- SingleR(test = denoised.sce.cc.genes,
                                   assay.type.test = "logcounts",
                                   ref = denoised.sce.deMicheli.cc.genes,
                                   labels = denoised.sce.deMicheli.cc.genes$cell_type)

# Assign cell types to primary data
denoised.sce.cc.genes$cell_type_deMicheli <- pred.deMicheli.cc.genes$pruned.labels

#saveRDS(pred.deMicheli.cc.genes, file = "./../saved/R_objects/pred_deMicheli_cc_genes")
```


#### 2.2.2 Diagnostic plots without cc genes (pdf documents)
**Diagnostic plots**
```{r deMicheli-annotation-diagnostic-plots-cc-genes}
# Score heatmap
plotScoreHeatmap(pred.deMicheli.cc.genes, 
                 annotation_col = as.data.frame(colData(denoised.sce.cc.genes)[, "sample", drop = FALSE]), width = 10)

# Remove low-quality cells
to.remove <- pruneScores(pred.deMicheli.cc.genes, min.diff.next=0.1)
table(Label=pred.deMicheli.cc.genes$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(results = pred.deMicheli.cc.genes, show = "delta.med")
```


**Pdf files**
```{r deMicheli-annotation-diagnostic-plots-cc-genes-pdf, eval=FALSE}
# Visualize the score matrix
pdf("./../saved/figures/deMicheli_cc_genes_score_heatmap.pdf", width = 30, height = 50)
plotScoreHeatmap(pred.deMicheli.cc.genes, 
                 annotation_col = as.data.frame(colData(denoised.sce.cc.genes)[, "sample", drop = FALSE]), width = 10)
dev.off()

to.remove <- pruneScores(pred.deMicheli.cc.genes, min.diff.next=0.1)
table(Label=pred.deMicheli.cc.genes$labels, Removed=to.remove)


# Delta distribution
pdf("./../saved/figures/deMicheli_cc_genes_score_distribution.pdf", width = 20, height = 15)
plotScoreDistribution(results = pred.deMicheli.cc.genes, show = "delta.med")
dev.off()

# Get marker genes
all.markers.deMicheli <- metadata(pred.deMicheli.cc.genes)$de.genes

# Examine the expression of the marker genes for each label in the test dataset
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_cc_genes_d0_muscle.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d0_mature_skeletal_muscle)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_cc_genes_d0_musc.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d0_MuSCs_and_progenitors)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_cc_genes_d5_muscle.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d5_mature_skeletal_muscle)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_cc_genes_d5_musc.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d5_MuSCs_and_progenitors)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_cc_genes_d7_muscle.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d7_mature_skeletal_muscle)),
            fontsize_row = 2)
dev.off()
pdf("./../saved/figures/cell_annotation_heatmap_deMicheli_cc_genes_d7_musc.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_deMicheli",
            features=unique(unlist(all.markers.deMicheli$d7_MuSCs_and_progenitors)),
            fontsize_row = 2)
dev.off()
```


### 2.3 Refined cell mapping based on smaller segments on the trajectory
#### 2.3.1 All cell types
##### 2.3.1.1 Cell annotations with all cell types
```{r deMicheli-traj-inference-segments}
# Trajectory building
expression.deMicheli <- as.matrix(t(logcounts(denoised.sce.deMicheli)))
set.seed(123)
space.deMicheli <- reduce_dimensionality(expression.deMicheli, dist = "spearman", ndim = 2)
set.seed(123)
traj.deMicheli <- infer_trajectory(space.deMicheli)
traj.deMicheli <- reverse_trajectory(traj.deMicheli)

# Sort cells based on their progression
ordered <- sort(traj.deMicheli$time, decreasing = FALSE)

# Split cells into 10 segments based on their pseudo time value
n = 10
ordered_chunks = chunk(ordered, n.chunks = 10, shuffle = FALSE)

# Label cells by their segment
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[1]])] <- "segment_1"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[2]])] <- "segment_2"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[3]])] <- "segment_3"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[4]])] <- "segment_4"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[5]])] <- "segment_5"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[6]])] <- "segment_6"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[7]])] <- "segment_7"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[8]])] <- "segment_8"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[9]])] <- "segment_9"
denoised.sce.deMicheli$segment[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks[[10]])] <- "segment_10"
segment.deMicheli <- as.factor(denoised.sce.deMicheli$segment)

draw_trajectory_plot(space = space.deMicheli, 
                     progression_group = segment.deMicheli,
                     path = traj.deMicheli$path,
                     point_size = 1,
                     point_alpha = 0.5,
                     contour = FALSE) +
  ggtitle("Trajectory inference",
          subtitle = "De Micheli et al. dataset: All genes (ndim = 2) - Segments") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 14),
        axis.title = element_text(size = 16))
```

**Calculate singleR predictions (optional)**
```{r singleR-annotation-segments, eval=FALSE}
pred.segments <- SingleR(test = denoised.sce,
                         assay.type.test = "logcounts",
                         ref = denoised.sce.deMicheli,
                         labels = denoised.sce.deMicheli$segment)

#saveRDS(pred.segments, file = "./../saved/R_objects/pred_segments")

# Inspect the predictions
table(denoised.sce$sample, pred.segments.d5$pruned.labels)
```

**Load prediction results (if pre-saved prediction object available)**
```{r load-singleR-annotation-segments}
pred.segments <- readRDS("./../saved/R_objects/pred_segments")

# Inspect the predictions
tab.deMicheli.d5 <- table(denoised.sce$sample, pred.segments$pruned.labels)
```



##### 2.3.1.2 Diagnostic plots with all cell types grouped into segments (pdf documents)
```{r deMicheli-annotation-diagnostic-plots-segments-all-cells-pdf}
# Visualize the score matrix
plotScoreHeatmap(pred.segments, 
                 annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]), width = 10)

# Remove low-quality cells
to.remove <- pruneScores(pred.segments, min.diff.next = 0.1)
table(Label=pred.segments$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(results = pred.segments, show = "delta.med")
```


#### 2.3.2 D5 MuSCs and progenitors only
##### 2.3.2.1 Cell annotations with D5 MuSCs & progenitors
```{r deMicheli-traj-inference-segments-d5}
# Sort cells by their pseudo time value
ordered <- sort(traj.deMicheli$time, decreasing = FALSE)

# Subset only D5 samples
d5.muscs <- names(ordered) %in% colnames(denoised.sce.deMicheli[, denoised.sce.deMicheli$cell_type == "d5_MuSCs_and_progenitors"])
ordered.d5 <- ordered[d5.muscs]

# Split cells into 10 segments based on their pseudo time value
n = 10
ordered_chunks.d5 = chunk(ordered.d5, n.chunks = 10, shuffle = FALSE)

# Inspect min / max values of each segment
df.values <- data.frame(segment = c(1:10),
                        min_pseudo_time_value = c(min(ordered_chunks.d5[[1]]),
                                min(ordered_chunks.d5[[2]]),
                                min(ordered_chunks.d5[[3]]),
                                min(ordered_chunks.d5[[4]]),
                                min(ordered_chunks.d5[[5]]),
                                min(ordered_chunks.d5[[6]]),
                                min(ordered_chunks.d5[[7]]),
                                min(ordered_chunks.d5[[8]]),
                                min(ordered_chunks.d5[[9]]),
                                min(ordered_chunks.d5[[10]])),
                        max_pseudo_time_value = c(max(ordered_chunks.d5[[1]]),
                                max(ordered_chunks.d5[[2]]),
                                max(ordered_chunks.d5[[3]]),
                                max(ordered_chunks.d5[[4]]),
                                max(ordered_chunks.d5[[5]]),
                                max(ordered_chunks.d5[[6]]),
                                max(ordered_chunks.d5[[7]]),
                                max(ordered_chunks.d5[[8]]),
                                max(ordered_chunks.d5[[9]]),
                                max(ordered_chunks.d5[[10]])))
df.values

# Label cells by their segment
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[1]])] <- "segment_1"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[2]])] <- "segment_2"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[3]])] <- "segment_3"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[4]])] <- "segment_4"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[5]])] <- "segment_5"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[6]])] <- "segment_6"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[7]])] <- "segment_7"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[8]])] <- "segment_8"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[9]])] <- "segment_9"
denoised.sce.deMicheli$segment.d5[colnames(denoised.sce.deMicheli) %in% names(ordered_chunks.d5[[10]])] <- "segment_10"

# Replace NA values with "non d5 samples"
denoised.sce.deMicheli$segment.d5 <- replace_na(denoised.sce.deMicheli$segment.d5, "non_d5_musc_sample")

# Factorize the segments
segment.deMicheli.d5 <- as.factor(denoised.sce.deMicheli$segment.d5)

# Draw trajectory plot
colpalette.segments <- rainbow(11)
names(colpalette.segments) <- c("segment_1", "segment_2", "segment_3", "segment_4", "segment_5", "segment_6", "segment_7", "segment_8", "segment_9", "segment_10", "non_d5_musc_sample")
colpalette.segments["non_d5_musc_sample"] <- "#DCDCDC" # set to white


draw_trajectory_plot(space = space.deMicheli, 
                     progression_group = segment.deMicheli.d5,
                     progression_group_palette = colpalette.segments,
                     path = traj.deMicheli$path,
                     point_size = 1,
                     point_alpha = 0.5,
                     contour = FALSE) +
  ggtitle("Trajectory inference",
          subtitle = "De Micheli et al. dataset (Day 5 MuSCs & progenitors): All genes (ndim = 2) - Segments") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 14),
        axis.title = element_text(size = 16))
```

**Calculate singleR predictions (optional)**
```{r singleR-annotation-d5-segments, eval=FALSE}
pred.segments.d5 <- SingleR(test = denoised.sce,
                            assay.type.test = "logcounts",
                            ref = denoised.sce.deMicheli,
                            labels = denoised.sce.deMicheli$segment.d5)

#saveRDS(pred.segments.d5, file = "./../saved/R_objects/pred_segments_d5")

# Inspect the predictions
table(denoised.sce$sample, pred.segments.d5$pruned.labels)
```

**Load prediction results (if pre-saved prediction object available)**
```{r load-singleR-annotation-d5-segments}
pred.segments.d5 <- readRDS("./../saved/R_objects/pred_segments_d5")

# Print the de genes used
de.genes.pred.segments.d5 <- metadata(pred.segments.d5)$common.genes
print(de.genes.pred.segments.d5)

# Inspect the predictions
tab.deMicheli.d5 <- table(denoised.sce$sample, pred.segments.d5$pruned.labels)
```


##### 2.3.2.2 Diagnostic plots with D5 MuSCs & progenitors (pdf documents)
```{r deMicheli-annotation-diagnostic-plots-d5-MuSCS}
# Visualize the score matrix
plotScoreHeatmap(pred.segments.d5, 
                 annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]), width = 10)

to.remove <- pruneScores(pred.segments.d5, min.diff.med=0.2)
table(Label=pred.segments.d5$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(results = pred.segments.d5, show = "delta.med")
```


##### 2.3.2.3 Visualization of segment 10 on trajectory
```{r seg10-visualization-on-trajectory}
# Group cells by segment 10 vs. all other cells
primary.data.cells <- denoised.sce.deMicheli$segment.d5 == "segment_10"
other.cells <- !primary.data.cells
denoised.sce.deMicheli$primary.cells[primary.data.cells] <- "primary_data_cells"
denoised.sce.deMicheli$primary.cells[other.cells] <- "other_cell_types"

# Define progression group
prog.group <- as.factor(denoised.sce.deMicheli$primary.cells)

# Define a custom color palette (black / green)
colpalette <- c('primary_data_cells' ="#009900",
                'other_cell_types' = "#404040")

# Draw trajectory plot
draw_trajectory_plot(space = space.deMicheli, 
                     progression_group = prog.group,
                     progression_group_palette = colpalette,
                     path = traj.deMicheli$path,
                     point_size = 1,
                     point_alpha = 0.5,
                     contour = FALSE) +
  ggtitle("Trajectory inference",
          subtitle = "De Micheli et al. trajectory: Primary data cells shown on trajectory") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 14),
        axis.title = element_text(size = 16))
```

##### 2.3.2.4 Gene importances for Day 5 MuSCs
**Load pre-calculated gene importance objects (calculated in Trajectory_inference.Rmd script)**
```{r load-marker-genes-deMicheli}
# Load gimp and modules objects
gimp.deMicheli <- readRDS("./../saved/R_objects/gimp_deMicheli")
modules.deMicheli <- readRDS("./../saved/R_objects/modules_deMicheli")

gimp.deMicheli$qvalue <- p.adjust(p = gimp.deMicheli$pvalue, method = "BH")
gene_sel.deMicheli <- gimp.deMicheli$gene[gimp.deMicheli$qvalue < .05]
expr_sel.deMicheli <- scale_quantile(expression.deMicheli[, gene_sel.deMicheli])
```

```{r deMicheli-d5-muscs-gimp-modules-heatmap, eval=FALSE}
# Identify candidate marker genes from the Day 5 sample
group_name.deMicheli.d5 <- as.factor(denoised.sce.deMicheli$segment.d5)
  
pdf("./../saved/figures/modules_heatmap_deMicheli_d5_segments.pdf")
draw_trajectory_heatmap(expr_sel.deMicheli, 
                        time = traj.deMicheli$time,
                        progression_group = group_name.deMicheli.d5,
                        modules = modules.deMicheli,
                        show_labels_row = TRUE,
                        fontsize_row = 1)
dev.off()
```


## 3. Prediction of cell types from Dell'Orso et al. (2019) dataset
### 3.1 All genes
#### 3.1.1 Cell annotations
**Load pre-calculated predictions (if available)**
```{r load-dellOrso-cell-type-predictions}
# Load pre-saved prediction objects (with and without PMs)
pred.dellOrso <- readRDS("./../saved/R_objects/pred_dellOrso")
pred.dellOrso.f <- readRDS("./../saved/R_objects/pred_dellOrso_f")

# Print the de genes used
de.genes.pred.dellOrso <- metadata(pred.dellOrso)$common.genes
print(de.genes.pred.dellOrso)

de.genes.pred.dellOrso.f <- metadata(pred.dellOrso.f)$common.genes
print(de.genes.pred.dellOrso.f)

# Assign cell types to primary data
denoised.sce$cell_type_dellOrso <- pred.dellOrso$pruned.labels
denoised.sce$cell_type_dellOrso_f <- pred.dellOrso.f$pruned.labels
```

**Perform cell annotation using SingleR (optional)**
```{r dellOrso-cell-type-predictions, eval=FALSE}
########################
# With primary myoblasts
########################
pred.dellOrso <- SingleR(test = denoised.sce,
                         assay.type.test = "logcounts",
                         ref = denoised.sce.dellOrso,
                         labels = denoised.sce.dellOrso$cell_type)

# Assign cell types to primary data
denoised.sce$cell_type_dellOrso <- pred.dellOrso$pruned.labels

saveRDS(pred.dellOrso, file = "./../saved/R_objects/pred_dellOrso")

###########################
# Without primary myoblasts
###########################

# Filter out primary MBs
denoised.sce.dellOrso.f <- denoised.sce.dellOrso[, denoised.sce.dellOrso$cell_type != "Primary_MB"]

# SingleR prediction
pred.dellOrso.f <- SingleR(test = denoised.sce,
                         assay.type.test = "logcounts",
                         ref = denoised.sce.dellOrso.f,
                         labels = denoised.sce.dellOrso.f$cell_type)

saveRDS(pred.dellOrso.f, file = "pred_dellOrso_f")
```


#### 3.2.1 Diagnostic plots (pdf documents)
##### 3.2.1.1 With primary myoblasts
**diagnostics**
```{r dellOrso-annotation-diagnostic-plots}
# Score heatmap
plotScoreHeatmap(pred.dellOrso,  annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]))

# Remove low-quality cells
to.remove <- pruneScores(pred.dellOrso, min.diff.next = 0.1)
table(Label=pred.dellOrso$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(pred.dellOrso, show = "delta.med")
```


**pdf document**
```{r dellOrso-annotation-diagnostic-plots-pdf, eval=FALSE}
# Visualize the score matrix
pdf("./../saved/figures/dellOrso_score_heatmap.pdf")
plotScoreHeatmap(pred.dellOrso, 
                 annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]))
dev.off()

# Delta distribution
pdf("./../saved/figures/dellOrso_score_distribution.pdf")
plotScoreDistribution(pred.dellOrso, show = "delta.med")
dev.off()

# Get marker genes
all.markers.dellOrso <- metadata(pred.dellOrso)$de.genes

# Examine the expression of the marker genes for each label in the test dataset
pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_homeostatic_muscs.pdf")
plotHeatmap(denoised.sce, 
            order_columns_by="cell_type_dellOrso",
            features=unique(unlist(all.markers.dellOrso$homeostatic_MuSCs)),
            fontsize_row = 2)
dev.off()


pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_inj_60h_muscs.pdf")
plotHeatmap(denoised.sce, 
            order_columns_by="cell_type_dellOrso",
            features=unique(unlist(all.markers.dellOrso$inj_60h_MuSCs)),
            fontsize_row = 2)
dev.off()

pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_primary_mb.pdf")
plotHeatmap(denoised.sce, 
            order_columns_by="cell_type_dellOrso",
            features=unique(unlist(all.markers.dellOrso$Primary_MB)),
            fontsize_row = 2)
dev.off()
```

##### 3.2.1.1 Without primary myoblasts
```{r dellOrso-annotation-diagnostic-plots-without-pm}
# Score heatmap
plotScoreHeatmap(pred.dellOrso.f,  annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]))

# Remove low-quality cells
to.remove <- pruneScores(pred.dellOrso.f, min.diff.next = 0.1)
table(Label=pred.dellOrso.f$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(pred.dellOrso.f, show = "delta.med")
```


**pdf document**
```{r dellOrso-annotation-diagnostic-plots-without-pm-pdf, eval=FALSE}
# Visualize the score matrix
pdf("./../saved/figures/dellOrso_score_heatmap_f.pdf")
plotScoreHeatmap(pred.dellOrso.f, 
                 annotation_col = as.data.frame(colData(denoised.sce)[, "sample", drop = FALSE]))
dev.off()

# Delta distribution
pdf("./../saved/figures/dellOrso_score_distribution_f.pdf")
plotScoreDistribution(pred.dellOrso.f, show = "delta.med")
dev.off()

# Get marker genes
all.markers.dellOrso <- metadata(pred.dellOrso.f)$de.genes

# Examine the expression of the marker genes for each label in the test dataset
pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_homeostatic_muscs_f.pdf")
plotHeatmap(denoised.sce, 
            order_columns_by="cell_type_dellOrso_f",
            features=unique(unlist(all.markers.dellOrso$homeostatic_MuSCs)),
            fontsize_row = 2)
dev.off()


pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_inj_60h_muscs_f.pdf")
plotHeatmap(denoised.sce, 
            order_columns_by="cell_type_dellOrso_f",
            features=unique(unlist(all.markers.dellOrso$inj_60h_MuSCs)),
            fontsize_row = 2)
dev.off()
```



### 3.2 Without cell cycle genes
#### 3.2.1 Cell annotations without cc genes using Dell'Orso dataset
**Load pre-calculated predictions (if available)**
```{r load-dellOrso-cell-type-predictions-cc-genes}
pred.dellOrso.cc.genes <- readRDS("./../saved/R_objects/pred_dellOrso_cc_genes")

# Assign cell types to primary data
denoised.sce.cc.genes$cell_type_dellOrso <- pred.dellOrso.cc.genes$pruned.labels
```


**Perform cell annotation using SingleR (optional)**
```{r dellOrso-cell-type-predictions-cc-genes, eval=FALSE}
pred.dellOrso.cc.genes <- SingleR(test = denoised.sce.cc.genes,
                                  assay.type.test = "logcounts",
                                  ref = denoised.sce.dellOrso.cc.genes,
                                  labels = denoised.sce.dellOrso.cc.genes$cell_type)

# Assign cell types to primary data
denoised.sce.cc.genes$cell_type_dellOrso <- pred.dellOrso.cc.genes$pruned.labels

#saveRDS(pred.dellOrso.cc.genes, file = "./../saved/R_objects/pred_dellOrso_cc_genes")
```

**diagnostics**
```{r dellOrso-annotation-diagnostic-plots-cc-genes}
# Score heatmap
plotScoreHeatmap(pred.dellOrso.cc.genes, 
                 annotation_col = as.data.frame(colData(denoised.sce.cc.genes)[, "sample", drop = FALSE]), width = 10)

# Remove low-quality cells
to.remove <- pruneScores(pred.dellOrso.cc.genes, min.diff.next=0.1)
table(Label=pred.dellOrso.cc.genes$labels, Removed=to.remove)

# Delta distribution
plotScoreDistribution(results = pred.dellOrso.cc.genes, show = "delta.med")
```


**pdf documents**
#### 3.2.2 Diagnostic plots without cc genes (pdf documents)
```{r dellOrso-annotation-diagnostic-plots-cc-genes-pdf, eval=FALSE}
# Visualize the score matrix
pdf("./../saved/figures/dellOrso_cc_genes_score_heatmap.pdf", width = 30, height = 50)
plotScoreHeatmap(pred.dellOrso.cc.genes, 
                 annotation_col = as.data.frame(colData(denoised.sce.cc.genes)[, "sample", drop = FALSE]), width = 10)
dev.off()

# Delta distribution
pdf("./../saved/figures/dellOrso_cc_genes_score_distribution.pdf", width = 20, height = 15)
plotScoreDistribution(results = pred.dellOrso.cc.genes, show = "delta.med")
dev.off()

# Get marker genes
all.markers.dellOrso <- metadata(pred.dellOrso.cc.genes)$de.genes

# Examine the expression of the marker genes for each label in the test dataset
pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_cc_genes_homeostatic_muscs.pdf")
plotHeatmap(denoised.sce.cc.genes, 
            order_columns_by="cell_type_dellOrso",
            features=unique(unlist(all.markers.dellOrso$homeostatic_MuSCs)),
            fontsize_row = 2)
dev.off()


pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_cc_genes_inj_60h_muscs.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_dellOrso",
            features=unique(unlist(all.markers.dellOrso$inj_60h_MuSCs)),
            fontsize_row = 2)
dev.off()

pdf("./../saved/figures/cell_annotation_heatmap_dellOrso_cc_genes_primary_mb.pdf")
plotHeatmap(denoised.sce.cc.genes,
            order_columns_by="cell_type_dellOrso",
            features=unique(unlist(all.markers.dellOrso$Primary_MB)),
            fontsize_row = 2)
dev.off()
```

### 3.3 Save the DE genes used in SingleR predictions as .csv file
```{r save-singler-de-genes-used-as-csv-file, eval=FALSE}
write.csv(de.genes.pred.deMicheli, file = "./../saved/tables/de_genes_pred_deMicheli.csv")
write.csv(de.genes.pred.segments.d5, file = "./../saved/tables/de_genes_pred_deMicheli_segments_d5MuSCs.csv")
write.csv(de.genes.pred.dellOrso, file = "./../saved/tables/de_genes_pred_dellOrso.csv")
write.csv(de.genes.pred.dellOrso.f, file = "./../saved/tables/de_genes_pred_dellOrso_no_pm.csv")
```


## 4. Prediction of De Micheli cell types from Dell'Orso cell types and vice versa
### 4.1 Cell annotations
**Load pre-calculated predictions (if available)**
```{r load-reference-dataset-predictions}
# Dell'Orso as reference (de Micheli as test)
pred.reference <- readRDS("./../saved/R_objects/pred_reference")

# De Micheli as reference (Dell'Orso as test)
pred.reference2 <- readRDS("./../saved/R_objects/pred_reference2")
```

**Perform cell annotation using SingleR (optional)**
```{r cell-type-reference-datasets, eval=FALSE}
# Dell'Orso as reference
pred.reference <- SingleR(test = denoised.sce.deMicheli,
                          assay.type.test = "logcounts",
                          ref = denoised.sce.dellOrso,
                          labels = denoised.sce.dellOrso$cell_type)
#saveRDS(pred.reference, file = "./../saved/R_objects/pred_reference")

# De Micheli as reference
pred.reference2 <- SingleR(test = denoised.sce.dellOrso,
                          assay.type.test = "logcounts",
                          ref = denoised.sce.deMicheli,
                          labels = denoised.sce.deMicheli$cell_type)
#saveRDS(pred.reference2, file = "./../saved/R_objects/pred_reference2")
```

### 4.2 Visualization of predictions
```{r cell-type-reference-datasets-inspection}
# Dell'Orso as reference:
table(pred.reference$pruned.labels)
(table(pred.reference$pruned.labels, denoised.sce.deMicheli$cell_type))

# DeMicheli as reference
table(pred.reference2$pruned.labels)
table(pred.reference2$pruned.labels, denoised.sce.dellOrso$cell_type)
```


## 5. Visualization of cell annotation results
### 5.1 All genes
```{r cell-mapping-visualization}
# Inspection of predictions
table(pred.deMicheli$pruned.labels)
table(pred.dellOrso$labels)
table(pred.dellOrso.f$labels)

tab.deMicheli <- t(table(pred.deMicheli$pruned.labels, denoised.sce$sample)[, c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h")])
tab.dellOrso <- t(table(pred.dellOrso$pruned.labels, denoised.sce$sample)[, c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h")])
tab.dellOrso.f <- t(table(pred.dellOrso.f$pruned.labels, denoised.sce$sample)[, c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h")])

tab.deMicheli
tab.dellOrso
tab.dellOrso.f

## 'melt' tables
df.deMicheli <- melt(t(tab.deMicheli))
colnames(df.deMicheli) <- c("cell_type", "sample", "count")
df.dellOrso <- melt(t(tab.dellOrso))
colnames(df.dellOrso) <- c("cell_type", "sample", "count")

# Add missing cell types
df.deMicheli.missing.rows <- data.frame("cell_type" = c(rep("d0_MuSCs_and_progenitors", 5), rep("d0_mature_skeletal_muscle", 5), rep("d7_mature_skeletal_muscle", 5)),
                                        "sample" = rep(c("control", "cap50", "cap50_r4h", "cap50_r8h", "cap50_r16h"), 3),
                                        "count" = rep(0, 15))
df.dellOrso.missing.rows <- data.frame("cell_type" = rep("homeostatic_MuSCs", 5),
                                       "sample" = c("control", "cap50", "cap50_r4h", "cap50_r8h", "cap50_r16h"),
                                       "count" = rep(0, 5))

df.deMicheli <- rbind(df.deMicheli, df.deMicheli.missing.rows)
df.dellOrso <- rbind(df.dellOrso, df.dellOrso.missing.rows)

# De Micheli balloon plot
balloon.deMicheli <- ggballoonplot(df.deMicheli, x = "sample", y = "cell_type", size = "count",
              fill = "count", ggtheme = theme_bw()) +
  scale_fill_viridis_c(option = "C") +
  ggtitle("De Micheli et al. reference dataset: Mapping of primary data cells shown in a balloonplot")

# Dell Orso balloon plot
balloon.dellOrso <- ggballoonplot(df.dellOrso, x = "sample", y = "cell_type", size = "count",
              fill = "count", ggtheme = theme_bw()) +
  scale_fill_viridis_c(option = "C") +
  ggtitle("Dell'Orso et al. reference dataset: Mapping of primary data cells shown in a balloonplot")

balloon.deMicheli
balloon.dellOrso
```


### 5.2 Without cell cycle genes
```{r inspect-cell-types-cc-genes}
table(pred.deMicheli.cc.genes$pruned.labels)
table(pred.dellOrso.cc.genes$labels)

tab.deMicheli.cc.genes <- t(table(pred.deMicheli.cc.genes$pruned.labels, denoised.sce.cc.genes$sample)[, c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h")])

tab.dellOrso.cc.genes <- t(table(pred.dellOrso.cc.genes$pruned.labels, denoised.sce.cc.genes$sample)[, c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h")])

tab.deMicheli.cc.genes
tab.dellOrso.cc.genes
```


### 5.3 De Micheli: segments on trajectory
```{r deMicheli-cell-mapping-visualization-with-segments}
# Put predictions on a table
tab.deMicheli.segments <- table(denoised.sce$sample, pred.segments$pruned.labels)[c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h"),]
tab.deMicheli.segments.d5 <- table(denoised.sce$sample, pred.segments.d5$pruned.labels)[c("control", "cap50", "cap50_r4h","cap50_r8h","cap50_r16h"),]

tab.deMicheli.segments
tab.deMicheli.segments.d5

# Melt tables
df.deMicheli.s <- melt(tab.deMicheli.segments)
colnames(df.deMicheli.s) <- c("sample", "segment", "count")

df.deMicheli.s.d5 <- melt(tab.deMicheli.segments.d5)
colnames(df.deMicheli.s.d5) <- c("sample", "segment", "count")

# Add missing cell types
df.missing.rows.segments <- data.frame("sample" = rep(c("control", "cap50", "cap50_r4h", "cap50_r8h", "cap50_r16h"), 6),
                                       "segment" = c(rep("segment_1", 5), rep("segment_2", 5),rep("segment_3", 5),rep("segment_4", 5),
                                                     rep("segment_9", 5), rep("segment_10", 5)),
                                       "count" = rep(0, 30))

df.missing.rows.segments.d5 <- data.frame("sample" = rep(c("control", "cap50", "cap50_r4h", "cap50_r8h", "cap50_r16h"), 6),
                                       "segment" = c(rep("segment_1", 5), rep("segment_2", 5),rep("segment_3", 5),rep("segment_4", 5),
                                                     rep("segment_5", 5), rep("segment_6", 5)),
                                       "count" = rep(0, 30))

df.deMicheli.s <- rbind(df.deMicheli.s, df.missing.rows.segments)
df.deMicheli.s.d5 <- rbind(df.deMicheli.s.d5, df.missing.rows.segments.d5)

# De Micheli balloon plot
balloon.segments <- ggballoonplot(df.deMicheli.s, x = "sample", y = "segment", size = "count",
              fill = "count", ggtheme = theme_bw()) +
  scale_fill_viridis_c(option = "C") +
  ggtitle("De Micheli et al. reference dataset (divided into 10 segments)\n: Mapping of primary data cells shown in a balloonplot")

balloon.segments.d5 <- ggballoonplot(df.deMicheli.s.d5, x = "sample", y = "segment", size = "count",
              fill = "count", ggtheme = theme_bw()) +
  scale_fill_viridis_c(option = "C") +
  ggtitle("De Micheli et al. reference dataset (D5 MuSCs divided into 10 segments)\n: Mapping of primary data cells shown in a balloonplot")


balloon.segments
balloon.segments.d5

```

