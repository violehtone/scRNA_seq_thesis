---
title: "Downstream_analysis"
author: "Ville Lehtonen"
date: "9/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Set working dir to the source file location
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```
# Trajectory inference
SCORPIUS (https://github.com/rcannood/SCORPIUS) will be used for performing the trajectory inference as it is designed for inferring linear developmental trajectories from scRNA-seq data


## 1. Load packages and data
### Load packages
```{r load-packages, message=FALSE}
library(SCORPIUS)
library(scater)
library(scran)
library(SingleCellExperiment)
library(dplyr)
```


### Load saved sce objects
```{r load-objects}
# Load pre-processed sce objects
denoised.sce.deMicheli <- readRDS("./../saved/denoised_sce_deMicheli")
denoised.sce.dellOrso <- readRDS("./../saved/denoised_sce_dellOrso")
```


## 2. Trajectory inference
### 2.1 De Micheli et al. (2020) reference data
```{r deMicheli-traj-inference-final}
# Define groups
d0_muscle <- denoised.sce.deMicheli$injury == "Day 0" & denoised.sce.deMicheli$cell_annotation == "Mature skeletal muscle"
d0_musc <- denoised.sce.deMicheli$injury == "Day 0" & denoised.sce.deMicheli$cell_annotation == "MuSCs and progenitors"
d5_muscle <- denoised.sce.deMicheli$injury == "Day 5" & denoised.sce.deMicheli$cell_annotation == "Mature skeletal muscle"
d5_musc <- denoised.sce.deMicheli$injury == "Day 5" & denoised.sce.deMicheli$cell_annotation == "MuSCs and progenitors"
d7_muscle <- denoised.sce.deMicheli$injury == "Day 7" & denoised.sce.deMicheli$cell_annotation == "Mature skeletal muscle"
d7_musc <- denoised.sce.deMicheli$injury == "Day 7" & denoised.sce.deMicheli$cell_annotation == "MuSCs and progenitors"

denoised.sce.deMicheli$group[d0_musc] <- "d0_MuSCs_and_progenitors"
denoised.sce.deMicheli$group[d5_musc] <- "d5_MuSCs_and_progenitors"
denoised.sce.deMicheli$group[d7_musc] <- "d7_MuSCs_and_progenitors"
denoised.sce.deMicheli$group[d0_muscle] <- "d0_mature_skeletal_muscle"
denoised.sce.deMicheli$group[d5_muscle] <- "d5_mature_skeletal_muscle"
denoised.sce.deMicheli$group[d7_muscle] <- "d7_mature_skeletal_muscle"

# Create expression and sample objects
expression.deMicheli <- as.matrix(t(logcounts(denoised.sce.deMicheli)))
group_name.deMicheli <- as.factor(denoised.sce.deMicheli$group)

# Trajectory building
space.deMicheli <- reduce_dimensionality(expression.deMicheli, dist = "spearman", ndim = 2)
traj.deMicheli <- infer_trajectory(space.deMicheli)

draw_trajectory_plot(space = space.deMicheli, 
                     progression_group = group_name.deMicheli,
                     path = traj.deMicheli$path,
                     contour = TRUE) + ggtitle("De Micheli et al.: All genes (ndim = 2)")
```



### 2.2 Dell'Orso et al. (2019) reference data
```{r}
# Merge replicate samples to form groups per cell type
hom1 <- denoised.sce.dellOrso$sample == "homeostatic_MuSCs_rep1"
hom2 <- denoised.sce.dellOrso$sample == "homeostatic_MuSCs_rep2"
inj1 <- denoised.sce.dellOrso$sample == "inj_60h_MuSCs_rep1"
inj2 <- denoised.sce.dellOrso$sample == "inj_60h_MuSCs_rep2"
pmb <- denoised.sce.dellOrso$sample == "Primary_MB"
  
denoised.sce.dellOrso$cell_type[hom1] <- "homeostatic_MuSCs" 
denoised.sce.dellOrso$cell_type[hom2] <- "homeostatic_MuSCs" 
denoised.sce.dellOrso$cell_type[inj1] <- "inj_60h_MuSCs" 
denoised.sce.dellOrso$cell_type[inj2] <- "inj_60h_MuSCs" 
denoised.sce.dellOrso$cell_type[pmb] <- "Primary_MB"

# Create expression and sample objects
expression.dellOrso <- as.matrix(t(logcounts(denoised.sce.dellOrso)))
group_name.dellOrso <- as.factor(denoised.sce.dellOrso$cell_type)

# Trajectory inference
space.dellOrso <- reduce_dimensionality(expression.dellOrso, dist = "spearman", ndim = 2)
traj.dellOrso <- infer_trajectory(space.dellOrso)

# plot by sample
draw_trajectory_plot(space = space.dellOrso, 
                     progression_group = group_name.dellOrso,
                     path = traj.dellOrso$path,
                     contour = TRUE) + ggtitle("Dell'Orso et al. dataset: All genes, ndim = 2")
```


## 3. Identifying candidate marker genes
### 3.1 De Micheli et al. (2020) reference data
```{r marker-genes-deMicheli}
# Identify candidate marker genes
gimp.deMicheli <- gene_importances(x = expression.deMicheli,
                                   time = traj.deMicheli$time,
                                   num_permutations = 10,
                                   num_threads = 8)

gimp.deMicheli$qvalue <- p.adjust(p = gimp.deMicheli$pvalue, method = "BH")
gene_sel.deMicheli <- gimp.deMicheli$gene[gimp.deMicheli$qvalue < .05]
expr_sel.deMicheli <- expression.deMicheli[, gene_sel.deMicheli]

# Visualize expression of selected genes
draw_trajectory_heatmap(expr_sel.deMicheli, 
                        time = traj.deMicheli$time,
                        progression_group = group_name.deMicheli,
                        show_labels_row = TRUE,
                        fontsize_row = 8,)

# Group genes to modules
modules.deMicheli <- extract_modules(scale_quantile(expr_sel.deMicheli),
                                     time = traj.deMicheli$time,
                                     verbose = FALSE)

draw_trajectory_heatmap(expr_sel.deMicheli, 
                        time = traj.deMicheli$time,
                        progression_group = group_name.deMicheli,
                        modules = modules.deMicheli,
                        show_labels_row = TRUE,
                        fontsize_row = 5)

#saveRDS(modules.deMicheli, file = "./../saved/modules_deMicheli")
#saveRDS(gimp.deMicheli, file = "./../saved/gimp_deMicheli")

```
### 3.2 Dell'Orso et al. (2019) reference data
```{r marker-genes-dellOrso}
# Identify candidate marker genes
gimp.dellOrso <- gene_importances(x = expression.dellOrso,
                                  time = traj.dellOrso$time,
                                  num_permutations = 10,
                                  num_threads = 8)

gimp.dellOrso$qvalue <- p.adjust(gimp.dellOrso$pvalue, "BH", length(gimp.dellOrso$pvalue))
gene_sel.dellOrso <- gimp.dellOrso$gene[gimp.dellOrso$qvalue < .05]
expr_sel.dellOrso <- scale_quantile(expression.dellOrso[, gene_sel.dellOrso])

# Visualize expression of selected genes
draw_trajectory_heatmap(expr_sel.dellOrso, 
                        time = traj.dellOrso$time,
                        progression_group = group_name.dellOrso,
                        show_labels_row = TRUE,
                        fontsize_row = 8)

# Group genes to modules
modules.dellOrso <- extract_modules(scale_quantile(expr_sel.dellOrso),
                                     time = traj.dellOrso$time,
                                     verbose = FALSE)

draw_trajectory_heatmap(expr_sel.dellOrso, 
                        time = traj.dellOrso$time,
                        progression_group = group_name.dellOrso,
                        modules = modules.dellOrso,
                        show_labels_row = TRUE)

#saveRDS(modules.dellOrso, file = "./../saved/modules_dellOrso")
#saveRDS(gimp.dellOrso, file = "./../saved/gimp_dellOrso")
```



